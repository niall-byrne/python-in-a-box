name: Python In A Box Self Test

# Required Github Repository Secrets:
# REMOTE_TOKEN      - Github Token With Access To This Repo
# REMOTE_ORIGIN     - The git remote repository name
# SLACK_WEBHOOK     - The slack webhook for build notifications

on:
  push:
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

jobs:

  documentation_test:

    runs-on: ubuntu-latest

    steps:
      - name: Documentation -- Checkout Repository
        uses: actions/checkout@v2
        with:
          path: 'template'
      - name: Documentation -- Setup Environment
        run: |
          source ./template/.github/scripts/setup.sh
          source ./template/.github/scripts/template.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Documentation -- Check Markdown Links For Readme
        uses: gaurav-nelson/github-action-markdown-link-check@1.0.11
        with:
          use-quiet-mode: 'no'
          use-verbose-mode: 'yes'
          folder-path: 'template, template/.github/workflows'
          max-depth: 1
      - name: Documentation -- Check Markdown Links For Rendered Template
        uses: gaurav-nelson/github-action-markdown-link-check@1.0.11
        with:
          use-quiet-mode: 'no'
          use-verbose-mode: 'yes'
          folder-path: ${{ env.TEMPLATED_NAME }}
          max-depth: -1

      - name: Documentation -- Report Job Status on Success
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "documentation checks succeeded!"
      - name: Documentation -- Report Job Status on Failure
        if: failure()
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "documentation checks failed!"

  container_cli_test:

    runs-on: ubuntu-latest

    steps:
      - name: Container Test -- Checkout Repository
        uses: actions/checkout@v2
        with:
          path: 'template'
      - name: Container Test -- Setup Environment
        run: |
          source ./template/.github/scripts/setup.sh
          source ./template/.github/scripts/template.sh
        env:
            WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Container Test -- Ensure File System is Writable by the Container
        run: |
          sudo chmod -R o+w .
      - name: Container Test -- Build Docker Image, Start Container
        run: |
          cd ${TEMPLATED_NAME}
          docker-compose build
          docker-compose up -d
          sleep 1
      - name: Container Test -- Run TOML Linter
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" tomll /app/pyproject.toml
      - name: Container Test -- Test Build Documentation
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev build-docs
      - name: Container Test -- Test Build Wheel
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev build-wheel
      - name: Container Test -- Test the Coverage Command
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev coverage
      - name: Container Test -- Test the Fmt Command
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev fmt
      - name: Container Test -- Test the Lint Command
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev lint
      - name: Container Test -- Test the Reinstall Requirements Command
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev reinstall-requirements
      - name: Container Test -- Test the Sectest Command
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev sectest
      - name: Container Test -- Test the Setup Command
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev setup
      - name: Container Test -- Test the Setup Bash Command
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev setup-bash
      - name: Container Test -- Test the Test Command
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" dev test
      - name: Container Test -- Test Priviledge Escalation
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" sudo ls -la /root
      - name: Container Test -- Test Patch Pep Compliance
        run: |
          cd "${TEMPLATED_NAME}"
          docker-compose exec -T "${TEMPLATED_NAME}" git apply patches/pep.patch
          docker-compose exec -T "${TEMPLATED_NAME}" dev reinstall-requirements
          docker-compose exec -T "${TEMPLATED_NAME}" black --check .
          docker-compose exec -T "${TEMPLATED_NAME}" dev fmt

      - name: Container Test -- Report Job Status on Success
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "container build succeeded"
      - name: Container Test -- Report Job Status on Failure
        if: failure()
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "container build failed!"

  security_test:

    runs-on: ubuntu-latest

    steps:
      - name: Security Test -- Checkout Repository
        uses: actions/checkout@v1
      - name: Security Test -- Run Gitleaks
        uses: zricethezav/gitleaks-action@master

      - name: Security Test -- Report Job Status on Success
        run: |
          ./{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "seecurity checks succeeded!"
      - name: Security Test -- Report Job Status on Failure
        if: failure()
        run: |
          ./{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "security checks failed!"

  shellcheck_test:

    runs-on: ubuntu-latest

    steps:
      - name: Shellcheck -- Checkout Repository
        uses: actions/checkout@v2
        with:
          path: 'template'

      - name: Shellcheck -- Setup Environment
        run: |
          source ./template/.github/scripts/setup.sh
          source ./template/.github/scripts/template.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Shellcheck -- Check Template Scripts
        run: |
          shellcheck ./template/.github/scripts/*.sh
      - name: Shellcheck -- Check Rendered Template Scripts
        run: |
          shellcheck ${TEMPLATED_NAME}/.github/scripts/*.sh
          shellcheck ${TEMPLATED_NAME}/${TEMPLATED_NAME}/container_init.sh
          shellcheck ${TEMPLATED_NAME}/scripts/*.sh
          shellcheck ${TEMPLATED_NAME}/scripts/hooks/*

      - name: Shellcheck -- Report Job Status on Success
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "shellcheck checks succeeded!"
      - name: Shellcheck -- Report Job Status on Failure
        if: failure()
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "shellcheck checks failed!"

  hostmachine_cli_test:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.7]

    steps:
      - name: Hostmachine Test -- Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: Hostmachine Test -- Checkout Repository
        uses: actions/checkout@v2
        with:
          path: 'template'
      - name: Hostmachine Test -- Setup Environment
        run: |
          source ./template/.github/scripts/setup.sh
          source ./template/.github/scripts/template.sh
          pip install poetry
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Hostmachine Test -- Patch Environment
        run: |
          echo "PROJECT_NAME=${TEMPLATED_NAME}" >> "$GITHUB_ENV"
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Hostmachine Test -- Install Additional Hostmachine Software
        run: |
          sudo apt-get install -y golang-github-pelletier-go-toml
          sudo curl --fail -sL "https://github.com/zricethezav/gitleaks/releases/download/${GITLEAKSVERSION}/gitleaks-linux-amd64" -o /usr/bin/gitleaks
          sudo chmod +x /usr/bin/gitleaks
        env:
          GITLEAKSVERSION: "v7.2.0"
      - name: Hostmachine Test -- Setup Hostmachine Test
        run: |
          cd "${TEMPLATED_NAME}"
          ROOT="$(git rev-parse --show-toplevel)"
          echo "PIB_CONFIG_FILE_LOCATION=${ROOT}/assets/cli.yml" >> $GITHUB_ENV

      - name: Hostmachine Test -- Lint pyproject.toml
        run: |
          cd "${TEMPLATED_NAME}"
          tomll pyproject.toml
      - name: Hostmachine Test -- Install Hostmachine Scripts
        run: |
          cd "${TEMPLATED_NAME}"
          source ./scripts/extras.sh
          pib_setup_hostmachine
      - name: Hostmachine Test -- Test Build Documentation
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev build-docs
      - name: Hostmachine Test -- Test Build Wheel
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev build-wheel
      - name: Hostmachine Test -- Test the Coverage Command
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev coverage
      - name: Hostmachine Test -- Test the Fmt Command
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev fmt
      - name: Hostmachine Test -- Test the Lint Command
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev lint
      - name: Hostmachine Test -- Test the Reinstall Requirements Command
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev reinstall-requirements
      - name: Hostmachine Test -- Test the Sectest Command
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev sectest
      - name: Hostmachine Test -- Test the Setup Command
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev setup
      - name: Hostmachine Test -- Test the Setup Bash Command
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev setup-bash
      - name: Hostmachine Test -- Test the Test Command
        run: |
          cd "${TEMPLATED_NAME}"
          source "$(poetry env info --path)/bin/activate"
          dev test
      - name: Hostmachine Test -- Test Patch Pep Compliance
        run: |
          cd "${TEMPLATED_NAME}"
          git apply patches/pep.patch
          source "$(poetry env info --path)/bin/activate"
          dev reinstall-requirements
          black --check .
          dev fmt

      - name: Hostmachine Test -- Report Job Status on Success
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "hostmachine build success!"
      - name: Hostmachine Test -- Report Job Status on Failure
        if: failure()
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "hostmachine build failed!"

  workflow_lint_test:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [ 3.7 ]

    steps:
      - name: Workflow Lint -- Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: Workflow Lint -- Checkout Repository
        uses: actions/checkout@v2
        with:
          path: 'template'
      - name: Workflow Lint -- Setup Environment
        run: |
          source ./template/.github/scripts/setup.sh
          pip install yamllint
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Workflow Lint -- Create Template
        run: |
          source ./template/.github/scripts/template.sh

      - name: Workflow Lint -- Report Job Status on Success
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "workflow linting has passed!"
      - name: Workflow Lint -- Report Job Status on Failure
        if: failure()
        run: |
          ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "workflow linting has failed!"


  push_repository_test:
    needs: [container_cli_test, documentation_test, hostmachine_cli_test, security_test, shellcheck_test, workflow_lint_test]

    runs-on: ubuntu-latest

    steps:
    - name: Push Template -- Checkout Repository
      uses: actions/checkout@v2
      with:
        path: 'template'
        persist-credentials: false

    - name: Push Template -- Setup Environment
      run: |
        source ./template/.github/scripts/setup.sh
        source ./template/.github/scripts/template.sh "GitHub Action" "action@github.com"
      env:
        WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

    - name: Push Template -- Clean Up Tags for Git Push
      run: |
        cd "${TEMPLATED_NAME}"
        git checkout master
        git tag --delete v0.0.0  # Don't Repush
        git tag v1.0.0
    - name: Push Template -- Push master
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ secrets.REMOTE_TOKEN }}
        branch: master
        tags: false
        directory: ${{ env.TEMPLATED_NAME }}
        repository: ${{ secrets.REMOTE_ORIGIN }}
        force: true
    - name: Push Template -- Push production
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ secrets.REMOTE_TOKEN }}
        branch: production
        tags: false
        directory: ${{ env.TEMPLATED_NAME }}
        repository: ${{ secrets.REMOTE_ORIGIN }}
        force: true
    - name: Push Template -- Push release tag
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ secrets.REMOTE_TOKEN }}
        branch: production
        tags: true
        directory: ${{ env.TEMPLATED_NAME }}
        repository: ${{ secrets.REMOTE_ORIGIN }}
        force: true

    - name: Push Template -- Report Job Status on Success
      run: |
        ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "push has been triggered!"
    - name: Push Template -- Report Job Status on Failure
      if: failure()
      run: |
        ./template/{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "push has failed to trigger!"

  create_releases:
    needs: [push_repository_test]

    runs-on: ubuntu-latest

    steps:
      - name: Create Release -- Checkout Repository
        uses: actions/checkout@v1

      - name: Create Release -- Setup Environment
        if: contains(github.ref, '/tags/v')
        run: |
          source .github/scripts/setup.sh
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Create Release -- Prepare Release Content
        if: contains(github.ref, '/tags/v')
        run: |
          echo "{}" > package.json
      - name: Create Release -- Generate Changelog
        if: contains(github.ref, '/tags/v')
        uses: scottbrenner/generate-changelog-action@1.0.3
        id: Changelog
        env:
          REPO: ${{ github.repository }}
      - name: Create Release -- Generate Github Release Draft
        if: contains(github.ref, '/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.BRANCH_OR_TAG }}
          release_name: Release ${{ env.BRANCH_OR_TAG }}
          body: |
            ${{ steps.Changelog.outputs.changelog }}
            ## Deployment Checklist
            - [ ] Ensure correct version of pib_cli is installed
            - [ ] Ensure documentation is accurate
            - [ ] Ensure git commits are properly formatted
          draft: true
          prerelease: false

      - name: Create Release -- Report Job Status on Success
        if: contains(github.ref, '/tags/v')
        run: |
          ./{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "automated release has been created!\nhttps://github.com/${USERNAME}/${PROJECT_NAME}/releases"
      - name: Create Release -- Report Job Status on Failure
        if: failure()
        run: |
          ./{{cookiecutter.project_slug}}/.github/scripts/notifications.sh "${NOTIFICATION}" "automated release has failed!"
